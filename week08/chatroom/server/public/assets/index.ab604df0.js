var e=Object.defineProperty,t=(t,s,n)=>(((t,s,n)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n})(t,"symbol"!=typeof s?s+"":s,n),n);import{R as s,_ as n,r as i,a}from"./vendor.9a6e36f1.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var o={throttle:function(e,t){var s=(new Date).getTime();return function(){var n=(new Date).getTime();n-s>=t&&(s=n,e.apply(null,arguments))}}};function h(e){const{tools:t,selectedTool:i,onChange:a,onClearAll:o,onScreenShare:h}=e;return s.createElement("div",{className:"tool-bar"},n.map(t,(e=>s.createElement("span",{key:e.name,className:i===e.name?"active tool":"tool",onClick:()=>{"function"==typeof a&&a(e.name)}},e.text))),s.createElement("span",{className:"tool normal-btn",style:{marginLeft:"auto"},onClick:o},"清空"),s.createElement("span",{className:"tool normal-btn",onClick:h},"共享屏幕"))}class r extends i.exports.Component{constructor(...e){super(...e),this.width=0,this.height=0,this.videoRef=i.exports.createRef()}async componentDidMount(){try{let e=await window.navigator.mediaDevices.getDisplayMedia();const t=this.videoRef.current;this.width=t.offsetWidth,this.height=t.offsetHeight;const{socket:s}=this.props;t.addEventListener("loadeddata",(e=>{console.log("loaded");const n=document.createElement("canvas");n.width=this.width,n.height=this.height,this.context=n.getContext("2d"),this.interval=setInterval((()=>{this.context.drawImage(t,0,0,this.width,this.height);const e=n.toDataURL("images/jpeg",.2);s&&s.emit("screenSharing",e)}),100)})),t.srcObject=e,t.play()}catch(e){console.log(e),this.props.onBack()}}componentWillUnmount(){const e=this.videoRef.current;if(e&&e.srcObject){e.srcObject.getTracks().forEach((e=>e.stop())),e.srcObject=null}this.interval&&clearInterval(this.interval)}render(){const{onBack:e}=this.props;return s.createElement("div",{style:{position:"absolute",left:0,top:0,backgroundColor:"#fff",width:"100%",height:"100%",display:"flex",flexDirection:"column"}},s.createElement("div",{style:{height:60,padding:"0 10px",borderBottom:"1px solid #ccc",flex:"none",display:"flex",alignItems:"center"}},s.createElement("span",{className:"btn",onClick:e},"停止并返回")),s.createElement("div",{style:{flex:1,display:"flex",justifyContent:"center",alignItems:"center"}},s.createElement("video",{ref:this.videoRef,style:{width:800,height:600}})))}}class c extends i.exports.Component{constructor(...e){super(...e),t(this,"setUpCanvas",(()=>{const e=this.canvasRef.current,t=e.offsetWidth,s=e.offsetHeight;this.width=t,this.height=s;let n=e.getContext("2d");e.width=t,e.height=s,n.clearRect(0,0,t,s),this.context=n})),t(this,"drawImg",(e=>{if(console.log(1),e&&this.canvasRef&&this.canvasRef.current){console.log(2);const t=new Image;t.src=e,t.onload=()=>{this.context.drawImage(t,0,0,this.width,this.height)}}})),this.width=0,this.height=0,this.canvasRef=i.exports.createRef()}componentDidMount(){this.setUpCanvas(),this.props.socket.on("screenSharing",this.drawImg)}componentWillUnmount(){this.drawImg=null}render(){const{onBack:e}=this.props;return s.createElement("div",{style:{position:"absolute",left:0,top:0,backgroundColor:"#fff",width:"100%",height:"100%",display:"flex",flexDirection:"column"}},s.createElement("div",{style:{height:60,padding:"0 10px",borderBottom:"1px solid #ccc",flex:"none",display:"flex",alignItems:"center"}},s.createElement("span",{className:"btn",onClick:e},"关闭")),s.createElement("div",{style:{flex:1,display:"flex",justifyContent:"center",alignItems:"center"}},s.createElement("canvas",{ref:this.canvasRef,style:{width:800,height:600}})))}}class l{constructor(e,t,s){this.context=e,this.width=t.width,this.height=t.height,this.left=t.left,this.top=t.top,this.startDrawing=!1,this.startX=0,this.startY=0,this.endX=0,this.endY=0,this.shapes=[],this.currentShape=[],this.style=s||{color:"01A1D6",lineWidth:1}}mousedown(e){this.startDrawing=!0,this.startX=e.clientX-this.left,this.startY=e.clientY-this.top,this.currentShape=[],this.currentShape.push({x:this.startX,y:this.startY}),this.shapes.push(this.currentShape)}mousemove(e){this.startDrawing&&(this.endX=e.clientX-this.left,this.endY=e.clientY-this.top,this.currentShape.push({x:this.endX,y:this.endY}),this.draw())}mouseup(e){this.startDrawing=!1,this.endX=e.clientX-this.left,this.endY=e.clientY-this.top,this.currentShape.push({x:this.endX,y:this.endY}),this.sendData(this.currentShape)}clearAll(){this.shapes=[]}}const d=[{name:"pen",text:"钢笔"},{name:"line",text:"直线"},{name:"text",text:"文字"},{name:"rect",text:"矩形"},{name:"circle",text:"圆形"},{name:"ellipse",text:"椭圆"}],p={Pen:class extends l{constructor(e,t,s){super(e,t),this.socket=s}draw(){let{context:e,style:t,shapes:s}=this;e.strokeStyle="#"+t.color,e.lineWidth=t.lineWidth,e.lineJoin="round",s.forEach((t=>{let s=t[0];e.beginPath(),e.moveTo(s.x,s.y);for(let n=1;n<t.length;n++){let s=t[n];e.lineTo(s.x,s.y)}e.stroke(),e.closePath()}))}syncData(e){this.shapes.push(e)}sendData(e){this.socket.emit("draw",{shape:"Pen",data:e})}},Line:class extends l{constructor(e,t,s){super(e,t),this.socket=s}draw(){let{context:e,style:t,shapes:s}=this;e.strokeStyle="#"+t.color,e.lineWidth=t.lineWidth,s.forEach((t=>{let s=t[0],n=t[t.length-1];e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath()}))}syncData(e){this.shapes.push(e)}sendData(e){this.socket.emit("draw",{shape:"Line",data:e})}},Text:class extends l{constructor(e,t,s){super(e,t),this.socket=s}draw(){let{context:e,shapes:t}=this;e.font="48px serif",t.forEach((t=>{let s=t[0];e.fillText("Text",s.x,s.y)}))}syncData(e){this.shapes.push(e)}sendData(e){this.socket.emit("draw",{shape:"Text",data:e})}},Rect:class extends l{constructor(e,t,s){super(e,t),this.socket=s}draw(){let{context:e,style:t,shapes:s}=this;e.strokeStyle="#"+t.color,e.lineWidth=t.lineWidth,s.forEach((t=>{let s=t[0],n=t[t.length-1];const i=n.x-s.x,a=n.y-s.y;e.strokeRect(s.x,s.y,i,a)}))}syncData(e){this.shapes.push(e)}sendData(e){this.socket.emit("draw",{shape:"Rect",data:e})}},Circle:class extends l{constructor(e,t,s){super(e,t),this.socket=s}draw(){let{context:e,style:t,shapes:s}=this;e.strokeStyle="#"+t.color,e.lineWidth=t.lineWidth,s.forEach((t=>{let s=t[0],n=t[t.length-1];var i=(s.x+n.x)/2,a=(s.y+n.y)/2,o=Math.max(Math.abs(n.x-s.x),Math.abs(n.y-s.y))/2;e.beginPath(),e.arc(i,a,o,0,2*Math.PI,!1),e.closePath(),e.stroke()}))}syncData(e){this.shapes.push(e)}sendData(e){this.socket.emit("draw",{shape:"Circle",data:e})}},Ellipse:class extends l{constructor(e,t,s){super(e,t),this.socket=s}draw(){let{context:e,style:t,shapes:s}=this;e.strokeStyle="#"+t.color,e.lineWidth=t.lineWidth,s.forEach((t=>{let s=t[0],n=t[t.length-1];const i=(n.y-s.y)/2;e.beginPath(),e.moveTo(s.x,s.y),e.bezierCurveTo(s.x,s.y-i,n.x,s.y-i,n.x,s.y),e.bezierCurveTo(n.x,s.y+i,s.x,s.y+i,s.x,s.y),e.closePath(),e.stroke()}))}syncData(e){this.shapes.push(e)}sendData(e){this.socket.emit("draw",{shape:"Ellipse",data:e})}}};let m=new Map;class u extends i.exports.Component{constructor(...e){super(...e),t(this,"changeSelectedTool",(e=>{this.setState({selectedTool:e},(()=>{this.setShapeInstance(e)}))})),t(this,"setShapeInstance",(e=>{const t=e.replace(/^(\w)/,((e,t)=>t.toUpperCase()));if(m.has(t))this.shapeInstance=m.get(t);else{const e=this.canvasRef.current.getBoundingClientRect();this.shapeInstance=new p[t](this.getContext(),e,this.socket),m.set(t,this.shapeInstance)}})),t(this,"setUpScoket",(()=>{this.socket=io(),this.socket.on("connect",(()=>{console.log("Connected to server")})),this.socket.on("draw",(e=>{console.log("data",e);for(let[t,s]of m)t===e.shape&&s.syncData(e.data)})),this.socket.on("clearAll",(e=>{this.clearAll()})),this.socket.on("screenSharing",(e=>{this.confirmReceiveShare()}))})),t(this,"setUpCanvas",(()=>{const e=this.canvasRef.current,t=e.offsetWidth,s=e.offsetHeight;this.width=t,this.height=s;let n=e.getContext("2d");n.imageSmoothingEnabled=!0,e.width=t,e.height=s,n.clearRect(0,0,t,s),e.addEventListener("mousedown",(e=>{this.shapeInstance&&this.shapeInstance.mousedown.apply(this.shapeInstance,[e])}),!1),e.addEventListener("mousemove",o.throttle((e=>{this.shapeInstance&&this.shapeInstance.mousemove.apply(this.shapeInstance,[e])}),30),!1),e.addEventListener("mouseup",(e=>{this.shapeInstance&&this.shapeInstance.mouseup.apply(this.shapeInstance,[e])}),!1)})),t(this,"getContext",(()=>this.canvasRef.current.getContext("2d"))),t(this,"draw",(()=>{if(Date.now()-this.startTime>20){this.getContext().clearRect(0,0,this.width,this.height);for(let[e,t]of m)t.draw();this.startTime=Date.now()}window.requestAnimationFrame(this.draw)})),t(this,"onClearAll",(()=>{this.clearAll(),this.socket.emit("clearAll")})),t(this,"clearAll",(()=>{this.getContext().clearRect(0,0,this.width,this.height);for(let[e,t]of m)t.clearAll()})),t(this,"onScreenShare",(()=>{this.setState({shouldShowScreenShare:!0})})),t(this,"confirmReceiveShare",(()=>{if(!this.asking&&!this.ignoreScreenSharing&&!this.state.shouldShowScreenView){this.asking=!0;window.confirm("有人正在分享屏幕，是否查看？")?this.setState({shouldShowScreenView:!0},(()=>this.asking=!1)):(this.ignoreScreenSharing=!0,this.asking=!1)}})),this.state={selectedTool:"pen",shouldShowScreenShare:!1,shouldShowScreenView:!1},this.canvasRef=i.exports.createRef(),this.width=0,this.height=0,this.startTime=0,this.shapeInstance=null}componentDidMount(){this.setUpScoket(),this.setUpCanvas(),d.forEach((e=>this.setShapeInstance(e.name))),this.setShapeInstance(this.state.selectedTool),this.draw()}render(){return s.createElement("div",{className:"main-container"},s.createElement(h,{tools:d,selectedTool:this.state.selectedTool,onChange:this.changeSelectedTool,onClearAll:this.onClearAll,onScreenShare:this.onScreenShare}),s.createElement("div",{className:"canvas-container"},s.createElement("canvas",{ref:this.canvasRef})),this.state.shouldShowScreenShare?s.createElement(r,{onBack:()=>{this.setState({shouldShowScreenShare:!1})},socket:this.socket}):null,this.state.shouldShowScreenView?s.createElement(c,{onBack:()=>{this.setState({shouldShowScreenView:!1})},socket:this.socket}):null)}}a.render(s.createElement(s.StrictMode,null,s.createElement(u,null)),document.getElementById("root"));
